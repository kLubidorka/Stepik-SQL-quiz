import csv
import json

valid_book_refs = ['00000F', '000012', '000068', '000181', '0002D8', '0002DB', '0002E0', '0002F3', '00034E', '000352',
                   '000374', '00044D', '00044E', '0004B0', '0004E1', '000511', '00053F', '00054E', '0005E7', '0005F4',
                   '0005FF', '00067B', '0006C3', '0006F5', '000735', '000769', '000784', '0007A9', '0007ED', '0007FC',
                   '000836', '000842', '000859', '000862', '0008DF', '0008F4', '0008FD', '000909', '000917', '00094B',
                   '00098F', '000999', '0009D5', '0009ED', '000A1E', '000A39', '000AA7', '000AB3', '000ADA', '000B77',
                   '000B91', '000B97', '000BB3', '000BD8', '000BFF', '000C28', '000C2B', '000D3C', '000DBE', '000DC5',
                   '000E07', '000E3A', '000EA2', '000EFA', '000F07', '000F74', '000F7D', '000FAC', '000FD6', '00101D',
                   '00107C', '001089', '00111B', '00114E', '001164', '001184', '001191', '0011A9', '001233', '001269']

valid_ticket_nos = ['0005432034627', '0005432034628', '0005432034629', '0005432081476', '0005432081477',
                    '0005432106361', '0005432106386', '0005432133238', '0005432133239', '0005432133240',
                    '0005432262420', '0005432293273', '0005432328074', '0005432329491', '0005432329492',
                    '0005432359741', '0005432383559', '0005432460830', '0005432460831', '0005432527326',
                    '0005432528533', '0005432528534', '0005432529127', '0005432529998', '0005432531066',
                    '0005432531067', '0005432604244', '0005432660797', '0005432663023', '0005432706449',
                    '0005432706450', '0005432747729', '0005432891015', '0005432891016', '0005433009535',
                    '0005433036153', '0005433036154', '0005433036155', '0005433101280', '0005433151107',
                    '0005433192917', '0005433192918', '0005433192919', '0005433202287', '0005433342102',
                    '0005433342103', '0005433368030', '0005433368031', '0005433435011', '0005433634101',
                    '0005433722400', '0005433763203', '0005433785757', '0005433806172', '0005433846486',
                    '0005433867776', '0005433869064', '0005433869065', '0005433925347', '0005433986059',
                    '0005433986060', '0005433986395', '0005433986733', '0005433986734', '0005434022883',
                    '0005434022884', '0005434023206', '0005434023207', '0005434067063', '0005434067064',
                    '0005434069385', '0005434139997', '0005434139998', '0005434407173', '0005434407174',
                    '0005434444152', '0005434444153', '0005434448293', '0005434448294', '0005434480541',
                    '0005434480542', '0005434550605', '0005434550606', '0005434655397', '0005434993985',
                    '0005435070028', '0005435070029', '0005435127439', '0005435127440', '0005435177476',
                    '0005435214478', '0005435254536', '0005435286696', '0005435372110', '0005435375058',
                    '0005435377920', '0005435423700', '0005435424469', '0005435424470', '0005435425341',
                    '0005435541622', '0005435545944', '0005435545945', '0005435614475', '0005435653688',
                    '0005435653907', '0005435706114', '0005435706115', '0005435767739', '0005435767874',
                    '0005435788796', '0005435790266', '0005435790267', '0005435808109', '0005435838975']

valid_flight_ids = ['12819', '130', '21053', '17861', '28975', '24838', '25949', '21733', '8455', '30617', '3113',
                    '26730', '26252', '6991', '26516', '32587', '32591', '25908', '4996', '30635', '3313', '10943',
                    '20995', '24255', '6441', '4153', '30419', '24845', '8227', '5187', '30018', '26264', '7754',
                    '30140', '5508', '3129', '20111', '24246', '28562', '22015', '21355', '443', '13840', '30539',
                    '31887', '12609', '9354', '21003', '12034', '30620', '114', '2110', '1942', '26266', '5522', '8290',
                    '1744', '21451', '30108', '21722', '5332', '14753', '26270', '3471', '29241', '14202', '9331',
                    '22859', '15324', '9825', '15465', '11368', '22568', '30624', '17082', '17853', '5404', '30682',
                    '23384', '5297', '1039', '10928', '14523', '25923', '25670', '7739', '13490', '4298', '20355',
                    '20881', '391', '25673', '27026', '6141', '7947', '4780', '5475', '5328', '14560', '326964', '7722',
                    '21841', '957', '25232', '4708', '2139', '20606', '12084', '18058', '10896', '6365', '4177',
                    '25685', '30575', '24086', '19296', '11238', '326965', '1375', '12649', '18054', '26326', '26920',
                    '30596', '1045', '17122', '266', '31128', '31327', '12668', '31239', '1685', '18144', '1692',
                    '5575', '11516', '7737', '30695', '26987', '29483', '9269', '5084', '5995', '17382', '26194',
                    '21111', '27331', '9367', '3237', '5359', '24097', '23252', '23114', '3562', '7301', '21725',
                    '31278', '29117', '12987', '25694', '21716', '11924', '21068', '4557', '5347', '7742', '31110',
                    '435', '7472', '8612', '6492', '12505', '2957', '7766', '24839', '26425', '21717', '8555', '1498',
                    '8277', '9898', '22257', '17730', '326966', '30505', '11096', '10924', '4157', '5552', '7738',
                    '4766', '26316', '4626', '30613', '385', '17038', '6019', '2363', '26014', '20299', '6335', '2450',
                    '10560', '1835', '8495', '14484', '5287', '7064', '9891', '32675', '12824', '5336', '32695',
                    '28716', '18545', '3298', '27765', '13462', '6401', '24281', '23178', '21764', '5186', '7678',
                    '9616', '31663', '1684', '16562', '1967', '30588', '31265', '10925', '13136', '326951', '326952',
                    '326953', '326954', '326955', '326956', '326957', '326958', '326959', '326960', '326961', '326962',
                    '326963', '326964', '326965', '326966', '326967', '326968']


# К каждой строке из таблицы 'table_name' применяется функция 'row_updater'
# Затем обновленная таблица сохраняется в папку 'airtrans_new'
def update_table(table_name, row_updater):
    with open(f'airtrans_new/{table_name}.csv', mode='w') as csv_output_file:
        with open(f'airtrans_old/{table_name}.csv', mode='r') as csv_input_file:
            csv_reader = csv.reader(csv_input_file, delimiter=',')
            writer = csv.writer(csv_output_file, delimiter=',')
            line_count = 0
            for row in csv_reader:
                new_row = row_updater(row)
                if new_row != "":
                    writer.writerow(new_row)
                line_count += 1
            print(f'Processed {line_count} lines.')


# Вместо JSON оставляем один его элемент для упрощения
def update_aircrafts():
    def update_row_aircrafts(row):
        row[1] = json.loads(row[1])["en"]
        return row

    update_table('aircrafts', update_row_aircrafts)


# Вместо JSON оставляем один его элемент для упрощения
def update_airports():
    def update_row_airports(row):
        # row[1] = json.loads(row[1])["en"]
        # row[2] = json.loads(row[2])["en"]
        row[3] = "POINT" + row[3]
        row[3] = row[3].replace(',', ' ')
        return row

    update_table('airports', update_row_airports)


# Вместо JSON оставляем один его элемент для упрощения
def update_tickets():
    def update_row_tickets(row):
        row[4] = json.loads(row[4])["phone"]
        return row

    update_table('tickets', update_row_tickets)


# Сокращаем размер таблицы
def update_bookings():
    def update_row_bookings(row):
        if row[0] > "001269":
            return ""
        row[1] = row[1][:-3]
        return row

    update_table('bookings', update_row_bookings)


# Сокращаем размер таблицы
def update_tickets_2():
    def update_row_tickets(row):
        if row[1] in valid_book_refs:
            valid_ticket_nos.append(row[0])
            return row
        return ""

    update_table('tickets', update_row_tickets)


# Сокращаем размер таблицы
def update_boarding_passes():
    def update_row_boarding_passes(row):
        if row[0] in valid_ticket_nos:
            return row
        return ""

    update_table('boarding_passes', update_row_boarding_passes)


# Сокращаем размер таблицы
def update_ticket_flights():
    def update_row_ticket_flights(row):
        if row[0] in valid_ticket_nos:
            valid_flight_ids.append(row[1])
            return row
        return ""

    update_table('ticket_flights', update_row_ticket_flights)


# Сокращаем размер таблицы
def update_flights():
    def update_row_flights(row):
        if row[0] in valid_flight_ids:
            # row[2] = row[2][:-3]
            # row[3] = row[3][:-3]
            # row[8] = row[8][:-3]
            # row[9] = row[9][:-3]
            # if row[8] == "":
            #     row[8] = "NULL"
            # if row[9] == "":
            #     row[9] = "NULL"
            return row
        return ""

    update_table('flights', update_row_flights)


def update_all_csv_files():
    # update_aircrafts()
    # update_airports()

    # update_bookings()
    # update_tickets()
    # update_tickets_2()
    # update_boarding_passes()
    # update_flights()
    pass


if __name__ == '__main__':
    update_all_csv_files()
